<!DOCTYPE html>
<html lang="en">
  <head>
    <meta application/json charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    
    
    <title>Analytics</title>
    <!-- Linking Google font link for icons -->
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
    />
    <link
      href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="analytic.css" />
    <link rel="stylesheet" href="chatbot.css" />
  </head>
  <body>
    <aside class="sidebar">
      <div class="logo">
        <img
          src="images/a_stylized_illustration_of_a_worm_solarworm_wearing_sunglasses_and_a_smile_surrounded_by_solar_panels_and_composting_materials_like_leaves_and_fruit_peels_the_worm_is_holding_a_small_.jpeg"
          alt="logo"
        />
        <h2>Analytics</h2>
      </div>
      <ul class="links">
        <h4>Composting</h4>
        <li id="compost-dashboard">
          <span class="material-symbols-outlined">compost</span>
          <p>Dashboard</p>
        </li>
        <li id = "forecast">
          <span class="material-symbols-outlined">flag</span>
          <p>Forecast</p>
        </li>
        <li class="dropdown">
          <span class="material-symbols-outlined">menu</span>
          <p>Outliers</p>
          <ul class="submenu">
            <li class="heat" id="heat"><a href="#">Heat</a></li>
            <li class="humidity" id="humidity"><a href="#">Humidity</a></li>
            <li class="temperature" id="temperature">
              <a href="#">Temperature</a>
            </li>
            <li class="light" id="light"><a href="#">Light</a></li>
            <li class="nitrogen" id="nitrogen"><a href="#">Nitrogen</a></li>
            <li class="potassium" id="potassium"><a href="#">Potassium</a></li>
            <li class="phosphorus" id="phosphorus">
              <a href="#">Phosphorus</a>
            </li>
            <li class="sensor" id="sensor"><a href="#">Sensor Overview</a></li>
          </ul>
        </li>
        <hr />
        <h4>Solar (SOE)</h4>
        <li id="solar-dashboard">
          <span class="material-symbols-outlined">Solar_Power</span>
          <p>Dashboard</p>
        </li>


        <li class="dropdown">
          <span class="material-symbols-outlined">ambient_screen</span>
          <p>Energy Forecast</p>
          <ul class="submenu">
            <li id="prediction1">
              <p>COM 1</p>
            </li>
            <li id="prediction2">
              <p>COM 2</p>
            </li>
          </ul>
        </li>
        

        <li class="dropdown">
          <span class="material-symbols-outlined">warning</span>
          <p>Anomaly Detection</p>
          <ul class="submenu">
            <li id="anomaly-detection1">
    
              <p>Detection 1</p>
            </li>
            <li id="anomaly-detection2">
              <p>Detection 2</p>
            </li>
          </ul>
        </li>
        
        <!-- <li>
            
        </li> -->
        <!-- <li>
          <span class="material-symbols-outlined">monitoring</span>
          <p>Analytic</p>
        </li> -->
        <hr />
        <h4>Solar (Estate)</h4>

          <li id="solar-estate-dashboard">
            <span class="material-symbols-outlined">Solar_Power</span>
            <p>Dashboard</p>
          </li>

          <li id="monitoring">
            <span class="material-symbols-outlined">monitoring</span>
            <p>Monitor</p>
          </li>

          <li id="upload">
            <span class="material-symbols-outlined">Cloud_Upload</span>
            <p>Upload Files</p>
          </li>
          
        <hr />
        <li>
          <span class="material-symbols-outlined">home</span>
          <a href="loggedIn.html">Home</a>
        </li>
        <li class="logout-link">
          <span class="material-symbols-outlined">logout</span>
          <a href="index.html">Logout</a>
        </li>
      </ul>
    </aside>
    <section>
      <div id="compost-dashboard-div" class="compost-dashboard-div">
        <h1>Composting Dashboard</h1>
        <div class="dashboard">
          <iframe
            class="dashboard-iframe"
            title="mock"
            width="1140"
            height="541.25"
            src="https://app.powerbi.com/reportEmbed?reportId=ac74cd92-0720-4c20-8d2f-95bb6a9f144e&autoAuth=true&ctid=cba9e115-3016-4462-a1ab-a565cba0cdf1"
            frameborder="0"
            allowfullscreen="true"
          ></iframe>
        </div>
      </div>

      <div id="heat-outlier" class="heat-outlier">
        <h1>Heat Outliers</h1>
        <div class="dashboard">
          <iframe
            class="dashboard-iframe"
            title="Heat Outlier"
            width="1140"
            height="541.25"
            src="./Heat01_outlier_visual.html"
            frameborder="0"
          ></iframe>
        </div>
      </div>
      <div id="humidity-outlier" class="humidity-outlier">
        <h1>Humidity Outliers</h1>
        <div class="dashboard">
          <iframe
            class="dashboard-iframe"
            title="Humidity Outlier"
            width="1140"
            height="541.25"
            src="./Hum01_outlier_visual.html"
            frameborder="0"
          ></iframe>
        </div>
      </div>
      <div id="temperature-outlier" class="temperature-outlier">
        <h1>Temperature Outliers</h1>
        <div class="dashboard">
          <iframe
            class="dashboard-iframe"
            title="Temperature outlier"
            width="1140"
            height="541.25"
            src="./Temp01_outlier_visual.html"
            frameborder="0"
          ></iframe>
        </div>
      </div>
      <div id="light-outlier" class="light-outlier">
        <h1>Light Outliers</h1>
        <div class="dashboard">
          <iframe
            class="dashboard-iframe"
            title="Light Outlier"
            width="1140"
            height="541.25"
            src="./Light_Intensity_outlier_visual.html"
            frameborder="0"
          ></iframe>
        </div>
      </div>
      <div id="nitrogen-outlier" class="nitrogen-outlier">
        <h1>Nitrogen Outliers</h1>
        <div class="dashboard">
          <iframe
            class="dashboard-iframe"
            title="Nitrogen Outlier"
            width="1140"
            height="541.25"
            src="./Nitrogen01_outlier_visual.html"
            frameborder="0"
          ></iframe>
        </div>
      </div>
      <div id="potassium-outlier" class="potassium-outlier">
        <h1>Potassium Outliers</h1>
        <div class="dashboard">
          <iframe
            class="dashboard-iframe"
            title="Potassium Outlier"
            width="1140"
            height="541.25"
            src="./Potassium01_outlier_visual.html"
            frameborder="0"
          ></iframe>
        </div>
      </div>
      <div id="phosphorus-outlier" class="phosphorus-outlier">
        <h1>Phosphorus Outliers</h1>
        <div class="dashboard">
          <iframe
            class="dashboard-iframe"
            title="phosphorus Outlier"
            width="1140"
            height="541.25"
            src="./Phosphorous01_outlier_visual.html"
            frameborder="0"
          ></iframe>
        </div>
      </div>

      <div id="sensor-overview-div" class="sensor-overview-div">
        <h1>Sensor Overview</h1>
        <div class="dashboard">
          <iframe
            class="dashboard-iframe"
            title="Sensor Overview"
            width="1140"
            height="541.25"
            src="./Anomaly_pie_chart.html"
            frameborder="0"
          ></iframe>
        </div>
        <div class="pic">
          <img src="images/SHAP_plot.png" alt="Sensor Overview" />
        </div>
        <h3 class="description">
          Based on our analysis, the 'Nitrogen' sensor seems to cause the most data anomalies. We recommend upgrading the sensor with the below:
          <br>
          EcoWitt Sensors:https://www.amazon.com/dp/B0CN32DP48?ref_=cm_sw_r_cp_ud_dp_3GSSZ68HF23DHT3QHBGY
          <br>
          Monty Sensors: https://montycompost.co/
        </h3>
      </div>

      <div id = "npk-forecast" class="npk-forecast">
        
        <form id="npkForm">
          <h1>Enter NPK values for Forecast</h1>
          <div class="npk-form-group">
              <label for="nitrogen">Nitrogen (N):</label>
              <input type="number" id="nitrogen-form" name="nitrogen" step="any" required>
          </div>
          <div class="npk-form-group">
              <label for="phosphorus">Phosphorus (P):</label>
              <input type="number" id="phosphorus-form" name="phosphorus" step="any" required>
          </div>
          <div class="npk-form-group">
              <label for="potassium">Potassium (K):</label>
              <input type="number" id="potassium-form" name="potassium" step="any" required>
          </div>
          <div class="form-group">
            <button type="submit" id="retrain" class="btn btn-primary mt-3">Submit</button>
        </div>
        </form>
        <div>
          <h1>Forecasted NPK values</h1>
          <div class="dashboard" id="dataframe-container">
          </div>
        </div>

      
      </div>

      <div id="energy-prediction1" class="energy-prediction1">
        <h1>Energy Forecast</h1>
        <div class="dashboard">
          <iframe
            class="charts-iframe"
            title="Energy Prediction"
            width="1140"
            height="541.25"
            src="./forecast_COM1.html"
            frameborder="0"
            allowfullscreen="true"
          ></iframe>
        </div>
      </div>

      <div id="energy-prediction2" class="energy-prediction2">
        <h1>Energy Forecast</h1>
        <div class="dashboard">
          <iframe
            class="charts-iframe"
            title="Energy Prediction"
            width="1140"
            height="541.25"
            src="./forecast_COM2.html"
            frameborder="0"
            allowfullscreen="true"
          ></iframe>
        </div>
      </div>

      <div id="power_anomaly_detection_01" class="power_anomaly_detection_01">
        <h1>Power Anomaly Detection 1</h1>
        <div class="dashboard">
          <iframe
            class="charts-iframe"
            title="Power Anomaly Detection 1"
            width="1140"
            height="541.25"
            src="./ADS_COM1.html"
            frameborder="0"
          ></iframe>
        </div>
        <div class="description">
          <h3>
            Anomalies indicate unexpectedly low power energy generation during
            peak hours, potentially highlighting unusual behavior, system or
            sensor issues.
          </h3>
          <h3>
            Urgent Anomalies represent low power generation during peak hours
            when some environmental factors suggest high power generation,
            indicating a more severe problem.
          </h3>
        </div>
      </div>

      <div id="power_anomaly_detection_02" class="power_anomaly_detection_02">
        <h1>Power Anomaly Detection 2</h1>
        <div class="dashboard">
          <iframe
            class="charts-iframe"
            title="Power Anomaly Detection 2"
            src="./ADS_COM2.html"
            frameborder="0"
          ></iframe>
        </div>
        <div class="description">
          <h3>
            Anomalies indicate unexpectedly low power energy generation during
            peak hours, potentially highlighting unusual behavior, system or
            sensor issues.
          </h3>
          <h3>
            Urgent Anomalies represent low power generation during peak hours
            when some environmental factors suggest high power generation,
            indicating a more severe problem.
          </h3>
        </div>
      </div>

      <div id="solar-dashboard-div" class="solar-dashboard-div">
        <h1>Solar Dashboard</h1>
        <div class="dashboard">
          <img
            src="images/solardashboard.png"
            alt="Solar Panel"
            class="solar-panel"
          />
        </div>
      </div>


      <div id="monitoring-div" class="monitoring-div">
        <h1>Solar Monitoring</h1>
        <div class="dashboard">
          <iframe
            class="charts-iframe"
            title="Solar Monitoring"
            width="1140"
            height="541.25"
            src="./anomaly_detection.html"
            frameborder="0"
            allowfullscreen="true"
          ></iframe>  
        </div>

        <h1>Energy Forecast</h1>
        <div class="dashboard">
          <iframe
            class="charts-iframe"
            title="Energy Forecast"
            width="1140"
            height="541.25"
            src="./predicted_value.html"
            frameborder="0"
            allowfullscreen="true"
          ></iframe>
        </div>
      </div>
      
      <div id="estate-dashboard-div" class="estate-dashboard-div">
        <h1>Estate Dashboard</h1>
        <div class="dashboard">
          <iframe
            class="dashboard-iframe"
            title="Estate Dashboard"
            width="1140"
            height="541.25"
            src="https://app.powerbi.com/reportEmbed?reportId=d02e766f-54c3-44ce-9e6d-36d354f9bf9d&autoAuth=true&ctid=cba9e115-3016-4462-a1ab-a565cba0cdf1"
            frameborder="0"
            allowfullscreen="true"
          ></iframe>
        </div>
      </div>  


      <div id="upload-div" class="upload-div">
        <h1>Upload DPM and INV Files</h1>
        <div id="upload-form-div" class="upload-form-div">
          <form id="upload-form" method="POST" enctype="multipart/form-data" class="mt-4">
            <div class="form-group">
              <label for="dpm_file">DPM File:</label>
              <input type="file" class="form-control-file" name="dpm_file" id="dpm_file" required onchange="previewFile('dpm')">
            </div>
            <div id="dpm_table" class="table-container"></div>
            <div class="form-group">
              <label for="inv_file">INV File:</label>
              <input type="file" class="form-control-file" name="inv_file" id="inv_file" required onchange="previewFile('inv')">
            </div>
            <div id="inv_table" class="table-container"></div>
            <button type="submit" class="btn btn-primary">Upload</button>
          </form>
        </div>
      </div>

    </section>

    <div class="container">
      <div class="chatbox">
        <div class="chatbox__support">
          <div class="chatbox__header">
            <div class="chatbox__image--header">
              <img src="images/robot.png" alt="image" />
              <!-- <img src="https://img.icons8.com/color/48/000000/circled-user-female-skin-type-5--v1.png" alt="image"> -->
            </div>
            <div class="chatbox__content--header">
              <h4 class="chatbox__heading--header">Ecobot</h4>
              <p class="chatbox__description--header">
                Hi, How may I help you?
              </p>
            </div>
          </div>
          <div class="chatbox__messages">
            <div></div>
          </div>
          <div class="chatbox__footer">
            <input type="text" placeholder="Write a message..." />
            <button class="chatbox__send--footer send__button">Send</button>
          </div>
        </div>
        <div class="chatbox__button">
          <button><img src="./images/chat.png" /></button>
        </div>
      </div>
    </div>
    <script>
      document.getElementById('npkForm').addEventListener('submit', function(event) {
        event.preventDefault();
        const nitrogen = document.querySelector('#nitrogen-form').value;
        const phosphorus = document.querySelector('#phosphorus-form').value;
        const potassium = document.querySelector('#potassium-form').value;
        const user_ratio = `${nitrogen}:${phosphorus}:${potassium}`;
        console.log('Nitrogen (N):', nitrogen);
        console.log('Phosphorus (P):', phosphorus);
        console.log('Potassium (K):', potassium);
        console.log('User ratio:', user_ratio);
        $.ajax({
          url: 'http://127.0.0.1:5000/retrain',
          method: 'POST',
          contentType: 'application/json',
          dataType: 'json',
          data: JSON.stringify({
           user_ratio: user_ratio
          }),
          success: function(data) {
            if (data.status === 'success') {
               $('#dataframe-container').html(data.table);
             } else {
                  $('#dataframe-container').html('<p>' + data.message + '</p>');
              }
                  },
                  error: function(error) {
                      console.log('Error:', error);
                      $('#dataframe-container').html('<p>Error fetching data</p>');
                  }
              });
      
      });


    </script>

    <script>
      $(document).ready(function() {
          $('#forecast').click(function() {
              event.preventDefault();
              
              
              $.ajax({
                  url: 'http://127.0.0.1:5000/start',
                  method: 'POST',
                  
                  success: function(data) {
                      if (data.status === 'success') {
                          $('#dataframe-container').html(data.table);
                      } else {
                          $('#dataframe-container').html('<p>' + data.message + '</p>');
                      }
                  },
                  error: function(error) {
                      console.log('Error:', error);
                      $('#dataframe-container').html('<p>Error fetching data</p>');
                  }
              });
          });
      });
    </script>
    <script>
      function previewFile(type) {
        const file = document.getElementById(type + '_file').files[0];
        const reader = new FileReader();
        reader.onload = function(event) {
          const data = new Uint8Array(event.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const firstSheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[firstSheetName];
          const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
          displayTable(json, type);
        };
        reader.readAsArrayBuffer(file);
      }

      function displayTable(data, type) {
        let tableHtml = '<table><thead><tr>';
        data[0].forEach(header => {
          tableHtml += '<th>' + header + '</th>';
        });
        tableHtml += '</tr></thead><tbody>';
        for (let i = 1; i < data.length; i++) {
          tableHtml += '<tr>';
          data[i].forEach(cell => {
            tableHtml += '<td>' + (cell || '') + '</td>';
          });
          tableHtml += '</tr>';
        }
        tableHtml += '</tbody></table>';
        document.getElementById(type + '_table').innerHTML = tableHtml;
      }

      $(document).ready(function() {
        $('#upload-form').submit(function(event) {
          event.preventDefault();
          console.log("Form submission prevented.");
          const formData = new FormData(this);
          console.log("FormData prepared.");
          $.ajax({
            url: 'http://127.0.0.1:5001/process',
            type: 'POST',
            data: formData,
            contentType: false,
            processData: false,
            success: function(response) {
              console.log(response.data);
              alert('Files processed successfully!');
            },
            error: function(response) {
              alert('Failed to process files');
            }
          });
        });
      });
    </script>
    <script type="text/javascript" src="chatbot.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>
    <script src="analytics.js" defer></script>
  </body>
</html>
